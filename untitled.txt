import asyncio
import logging
from aiogram import Bot, Dispatcher, F
from aiogram.filters import Command
from aiogram.types import Message, InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
import aiohttp

# --- CONFIGURATION ---
API_TOKEN = "8340062727:AAFv5owhw2J_VHSC9aDfuOdcjXOdipyfcFM"
ALLOWED_GROUP_ID = -1002752217221
VIP_USER_ID = 6853944247

# Logging setup (‡¶Ø‡¶æ‡¶§‡ßá ‡¶è‡¶∞‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡ßü)
logging.basicConfig(level=logging.INFO)

bot = Bot(token=API_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()

# --- BUTTONS ---
def join_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üì¢ Join Channel", url="https://t.me/jexarofficial")]
    ])

# --- API FUNCTION ---
async def fetch_json(url):
    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(url) as r:
                if r.status == 200:
                    return await r.json()
    except Exception as e:
        print(f"API Error: {e}")
    return None

# --- START COMMAND ---
@dp.message(Command("start"))
async def start_handler(msg: Message):
    if msg.chat.id != ALLOWED_GROUP_ID:
        await msg.reply(f"‚ùå This bot only works in the authorized group.\nGroup ID: {ALLOWED_GROUP_ID}")
        return
    await msg.reply("‚úÖ Bot is Online and Ready!\nUse: /like bd <uid>")

# --- LIKE COMMAND ---
@dp.message(Command("like"))
async def like_handler(msg: Message):
    # ‡ßß. ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
    if msg.chat.id != ALLOWED_GROUP_ID:
        await msg.reply("‚ùå ‡¶è‡¶á ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶Ö‡¶´‡¶ø‡¶∏‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá‡•§", reply_markup=join_keyboard())
        return

    parts = msg.text.split()
    
    # ‡ß®. ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ö‡ßá‡¶ï
    if len(parts) != 3:
        await msg.reply("‚ùó ‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶ø‡ßü‡¶Æ‡•§ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶ø‡ßü‡¶Æ:\n<code>/like bd 1234567890</code>", reply_markup=join_keyboard())
        return

    region, uid = parts[1].upper(), parts[2]

    # ‡ß©. ‡¶∞‡¶ø‡¶ú‡¶ø‡ßü‡¶® ‡¶ö‡ßá‡¶ï
    if region not in ["BD", "IND"]:
        await msg.reply("‚ùó ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ BD ‡¶Ö‡¶•‡¶¨‡¶æ IND ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡•§")
        return

    wait_msg = await msg.reply("‚è≥ Connecting to server... Please wait.")

    # ‡ß™. API ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ
    # ‡¶¶‡ßç‡¶∞‡¶∑‡ßç‡¶ü‡¶¨‡ßç‡¶Ø: ‡¶è‡¶á API ‡¶Ø‡¶¶‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá, ‡¶§‡¶¨‡ßá ‡¶¨‡¶ü‡ßá‡¶∞ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶®‡ßá‡¶á‡•§
    url = f"https://anish-likes.vercel.app/like?server_name={region.lower()}&uid={uid}&key=jex4rrr"
    
    data = await fetch_json(url)

    if not data:
        await wait_msg.edit_text("‚ùå Server Error: API ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá ‡¶®‡¶æ ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶¶‡¶ø‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§")
        return

    # ‡ß´. ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç
    if data.get("status") == 2:
        await wait_msg.edit_text(
            f"üö´ <b>Daily Limit Reached!</b>\n"
            f"UID: <code>{uid}</code>\n"
            f"Name: {data.get('PlayerNickname', 'Unknown')}\n"
            f"‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Æ‡¶§ ‡¶≤‡¶æ‡¶á‡¶ï ‡¶∂‡ßá‡¶∑‡•§ ‡¶ï‡¶æ‡¶≤ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"
        )
    else:
        await wait_msg.edit_text(
            f"‚úÖ <b>Likes Sent Successfully!</b>\n\n"
            f"üë§ <b>Name:</b> {data.get('PlayerNickname', 'N/A')}\n"
            f"üÜî <b>UID:</b> <code>{uid}</code>\n"
            f"‚ù§Ô∏è <b>Likes Given:</b> {data.get('LikesGivenByAPI', 'N/A')}\n"
            f"üìä <b>Total Likes:</b> {data.get('LikesafterCommand', 'N/A')}\n\n"
            f"ü§ñ <b>Powered By JEX AI</b>",
            reply_markup=join_keyboard()
        )

# --- RUN BOT ---
async def main():
    print("ü§ñ Bot is running...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())