<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hamster Kombat ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ Mini App</title>
    

<script src="https://cdn.tailwindcss.com"></script>
    

<script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ‡¶´‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #333;
            transition: background-color 0.3s ease;
        }
        .card {
            background-color: #ffffff;
            transition: background-color 0.3s ease;
        }
        /* ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        #click-area {
            cursor: pointer;
            transition: transform 0.1s ease-out;
            touch-action: manipulation;
            user-select: none;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/1d/Hamster_drawing.svg/1200px-Hamster_drawing.svg.png'); /* ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡¶æ‡¶≤‡ßç‡¶™‡¶®‡¶ø‡¶ï ‡¶π‡ßç‡¶Ø‡¶æ‡¶Æ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶õ‡¶¨‡¶ø */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            min-height: 200px;
        }
        #click-area:active {
            transform: scale(0.95);
        }
        /* ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® ‡¶ú‡¶®‡ßç‡¶Ø */
        .point-feedback {
            position: absolute;
            font-size: 2em;
            font-weight: bold;
            color: #fca311; /* ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ó‡ßã‡¶≤‡ßç‡¶°‡ßá‡¶® ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ */
            opacity: 0;
            animation: fade-up 1s forwards;
            pointer-events: none;
        }
        @keyframes fade-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
    </style>
    <!-- ‡ßß. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶∞‡¶¨‡¶∞‡¶æ‡¶π‡¶ï‡ßÉ‡¶§ Monetag SDK ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã -->
    <script src='//libtl.com/sdk.js' data-zone='10158413' data-sdk='show_10158413'></script>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-gray-50">

    <div id="app-container" class="w-full max-w-md card rounded-xl shadow-2xl p-6 md:p-8 space-y-6">

        <h1 class="text-3xl font-bold text-gray-900 text-center mb-2">
            üêπ Hamster Kombat (‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤)
        </h1>
        <p class="text-gray-500 text-center text-sm">
            ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßÅ‡¶®!
        </p>
        
        <!-- ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¨‡¶ï‡ßç‡¶∏ -->
<div id="status-message" class="bg-blue-100 p-4 rounded-lg text-sm text-blue-800 font-medium hidden">
            

‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
        </div>

        <!-- ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá -->
<div class="text-center p-4 bg-yellow-50 rounded-lg shadow-inner border border-yellow-200">
            <p class="text-lg text-gray-700 font-medium">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏:</p>
            <p id="balance-display" class="text-5xl md:text-6xl font-extrabold text-yellow-600 animate-pulse">
                0
            </p>
        </div>

        <!-- Profit per Hour ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá -->
<div class="flex items-center justify-center bg-green-50 p-3 rounded-lg text-sm font-medium text-green-700 shadow-sm border border-green-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd" />
            </svg>
            <span>Profit per Hour: <span id="profit-per-hour-display" class="font-bold">0</span></span>
        </div>
        
        <!-- ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶®‡¶ø‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
        <div id="ad-placement-section" class="pt-4 pb-2">
            <button id="reward-ad-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-lg shadow-md transition duration-200 disabled:bg-gray-400">
                ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶®‡¶ø‡¶® (+5,000)
            </button>
        </div>


        <!-- ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ -->
<div id="click-area" class="relative w-full aspect-square bg-gray-100 rounded-xl flex items-center justify-center shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-[1.01]">
            

</div>

        <!-- ‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶° ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
<div class="space-y-4 pt-2">
            <h2 class="text-xl font-bold text-gray-800 text-center">‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            <div id="upgrades-list" class="space-y-3">
                
                <!-- ‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶Æ‡¶æ‡¶á‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶° ‡¶ï‡¶æ‡¶∞‡ßç‡¶° -->
<div class="bg-gray-100 p-4 rounded-lg flex justify-between items-center shadow-sm">
                    <div>
                        <p class="font-semibold text-gray-700">‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶Æ‡¶æ‡¶á‡¶®‡¶æ‡¶∞</p>
                        <p class="text-sm text-gray-500">‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá <span class="font-bold">1</span> ‡¶≤‡¶æ‡¶≠</p>
                    </div>
                    <button data-upgrade-id="basic_miner" data-cost="1000" data-profit="1" class="upgrade-btn bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:bg-gray-400">
                        ‡¶ï‡ßá‡¶®‡¶æ‡¶∞ ‡¶ñ‡¶∞‡¶ö: <span class="cost-display">1,000</span>
                    </button>
                </div>
                

</div>
        </div>
        
        <!-- ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá -->
<div class="bg-gray-100 p-3 rounded-lg text-xs break-words">
            <p class="font-semibold text-gray-700">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø:</p>
            <code id="user-id-display" class="text-gray-500 font-mono text-xs">... ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá ...</code>
        </div>
        
        <!-- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
        <button id="close-app-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg shadow-sm transition duration-200">
            Mini App ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>

    </div>

    <script type="module">
        // Firebase ‡¶Æ‡¶°‡¶ø‡¶â‡¶≤‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶á‡¶Æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, collection, onSnapshot, 
            serverTimestamp, setLogLevel, runTransaction, updateDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ü‡ßá‡¶ü
        const statusMessage = document.getElementById('status-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const balanceDisplay = document.getElementById('balance-display');
        const profitPerHourDisplay = document.getElementById('profit-per-hour-display');
        const clickArea = document.getElementById('click-area');
        const upgradesList = document.getElementById('upgrades-list');
        const closeAppBtn = document.getElementById('close-app-btn');
        const rewardAdBtn = document.getElementById('reward-ad-btn');

        let db = null;
        let auth = null;
        let userId = null;
        let WebApp = null;
        let currentBalance = 0;
        let profitPerHour = 0;
        let lastCollectTime = Date.now(); 
        let autoCollectInterval = null;

        // ‡¶ó‡ßá‡¶Æ‡ßá‡¶∞ ‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶° ‡¶°‡ßá‡¶ü‡¶æ
        const gameUpgrades = [
            { id: 'basic_miner', name: '‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶Æ‡¶æ‡¶á‡¶®‡¶æ‡¶∞', baseCost: 1000, profit: 1, level: 0 },
            { id: 'advanced_miner', name: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶≠‡¶æ‡¶®‡ßç‡¶∏‡¶° ‡¶Æ‡¶æ‡¶á‡¶®‡¶æ‡¶∞', baseCost: 5000, profit: 5, level: 0 },
            { id: 'pro_miner', name: '‡¶™‡ßç‡¶∞‡ßã ‡¶Æ‡¶æ‡¶á‡¶®‡¶æ‡¶∞', baseCost: 25000, profit: 25, level: 0 }
        ];

        setLogLevel('Debug');

        // ‡¶á‡¶â‡¶ü‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'border-red-400', 'bg-blue-100', 'text-blue-800', 'border-blue-200');
            if (isError) {
                statusMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-400');
            } else {
                statusMessage.classList.add('bg-blue-100', 'text-blue-800', 'border-blue-200');
            }
        }
        
        // ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ‡ßá UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function updateUI() {
            balanceDisplay.textContent = Math.floor(currentBalance).toLocaleString('bn-BD');
            profitPerHourDisplay.textContent = (profitPerHour * 3600).toLocaleString('bn-BD'); 
            
            gameUpgrades.forEach(upgrade => {
                const button = upgradesList.querySelector(`[data-upgrade-id="${upgrade.id}"]`);
                if (button) {
                    const cost = upgrade.baseCost * Math.pow(1.5, upgrade.level); 
                    button.querySelector('.cost-display').textContent = Math.floor(cost).toLocaleString('bn-BD');
                    button.disabled = currentBalance < cost;
                    button.title = `‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶≤‡ßá‡¶≠‡ßá‡¶≤: ${upgrade.level}`;
                }
            });
            WebApp?.MainButton.setParams({ text: `‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ${Math.floor(currentBalance).toLocaleString('bn-BD')}`, is_active: true });
        }

        // ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡¶æ
        function collectIdleProfit() {
            const now = Date.now();
            const timeElapsedSeconds = (now - lastCollectTime) / 1000;
            const pointsToAdd = timeElapsedSeconds * profitPerHour;
            
            if (pointsToAdd > 0.01) { 
                currentBalance += pointsToAdd;
                lastCollectTime = now;
                updateUI();
                saveGameDataToFirestore(); 
            }
        }

        // === ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ===
        async function saveGameDataToFirestore() {
            if (!db || !userId) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/game_data/player_stats`);

            try {
                await setDoc(docRef, { 
                    balance: currentBalance,
                    profitPerHour: profitPerHour,
                    upgrades: gameUpgrades.map(u => ({ id: u.id, level: u.level })),
                    lastCollectTime: serverTimestamp()
                }, { merge: true });
                showStatus(`‚ö°Ô∏è ‡¶ó‡ßá‡¶Æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, false);

            } catch (error) {
                console.error("Firestore ‡¶∏‡ßá‡¶≠ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:", error);
                showStatus(`‚ùå ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${error.message}`, true);
            }
        }

        // === ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá ‡¶™‡ßÅ‡¶∞‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (Monetag Call) ===
        function handleAdReward() {
            const BONUS_POINTS = 5000;
            rewardAdBtn.disabled = true;
            rewardAdBtn.textContent = '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';

            // Monetag SDK ‡¶•‡ßá‡¶ï‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
            const adFunction = window.show_10158413; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ data-sdk ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßç‡¶∞‡¶ø‡¶¨‡¶ø‡¶â‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ

            if (typeof adFunction === 'function') {
                try {
                    // ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ
                    adFunction(); 

                    showStatus("‚è≥ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡ß™ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá...", false);

                    // **‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶° ‡¶∞‡¶ø‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ú‡¶ø‡¶ï:**
                    // ‡¶™‡ßç‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá, ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá Monetag ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®‡ßá‡¶∞ ‡¶∏‡¶´‡¶≤ ‡¶∏‡¶Æ‡¶æ‡¶™‡ßç‡¶§‡¶ø‡¶∞ ‡¶ï‡¶≤‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§
                    // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶™‡ßÅ‡¶∞‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§
                    setTimeout(() => {
                        // ‡¶™‡ßÅ‡¶∞‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                        currentBalance += BONUS_POINTS;
                        updateUI();
                        saveGameDataToFirestore();
                        
                        showStatus(`üéâ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∏‡¶´‡¶≤! ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ${BONUS_POINTS.toLocaleString('bn-BD')} ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, false);
                        
                        rewardAdBtn.textContent = `‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶®‡¶ø‡¶® (+${BONUS_POINTS.toLocaleString('bn-BD')})`;
                        rewardAdBtn.disabled = false;
                    }, 4000); // 4 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ

                } catch (e) {
                    // Ad failed to load/show
                    console.error("Monetag Ad Error:", e);
                    showStatus(`‚ö†Ô∏è ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶¨‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø: ${e.message || 'Ad failed to load.'}`, true);
                    
                    rewardAdBtn.textContent = `‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶®‡¶ø‡¶® (+${BONUS_POINTS.toLocaleString('bn-BD')})`;
                    rewardAdBtn.disabled = false;
                }
            } else {
                // SDK not loaded
                showStatus("‚ùå Monetag ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (show_10158413) ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ SDK ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ï‡¶ø‡¶®‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", true);
                rewardAdBtn.textContent = `‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶®‡¶ø‡¶® (+${BONUS_POINTS.toLocaleString('bn-BD')})`;
                rewardAdBtn.disabled = false;
            }
        }


        // === ‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶° ‡¶ï‡ßá‡¶®‡¶æ ===
        async function buyUpgrade(upgradeId) {
            if (!db || !userId) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/game_data/player_stats`);

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (!docSnap.exists()) {
                        throw "‡¶ñ‡ßá‡¶≤‡ßã‡¶Ø‡¶º‡¶æ‡¶°‡¶º‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!";
                    }

                    const data = docSnap.data();
                    let currentBalanceInDb = data.balance || 0;
                    let currentProfitPerHourInDb = data.profitPerHour || 0;
                    let currentUpgrades = data.upgrades || [];

                    const upgradeInfo = gameUpgrades.find(u => u.id === upgradeId);
                    if (!upgradeInfo) throw "‡¶è‡¶á ‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶°‡¶ü‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§";

                    const currentUpgradeLevel = currentUpgrades.find(u => u.id === upgradeId)?.level || 0;
                    const cost = upgradeInfo.baseCost * Math.pow(1.5, currentUpgradeLevel);

                    if (currentBalanceInDb < cost) {
                        throw "‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á!";
                    }

                    // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                    currentBalanceInDb -= cost;
                    currentProfitPerHourInDb += upgradeInfo.profit;
                    
                    // ‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶° ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                    const newUpgrades = currentUpgrades.filter(u => u.id !== upgradeId);
                    newUpgrades.push({ id: upgradeId, level: currentUpgradeLevel + 1 });

                    transaction.update(docRef, {
                        balance: currentBalanceInDb,
                        profitPerHour: currentProfitPerHourInDb,
                        upgrades: newUpgrades,
                        lastUpdated: serverTimestamp()
                    });
                });

                showStatus(`üéâ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶° ‡¶ï‡ßá‡¶®‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`, false);

            } catch (error) {
                console.error("‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶° ‡¶ï‡ßá‡¶®‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:", error);
                showStatus(`‚ùå ‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶° ‡¶ï‡¶ø‡¶®‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${error.message}`, true);
            }
        }


        // === ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤‡¶æ‡¶∞ ===
        function handleClick(event) {
            currentBalance += 1; 
            updateUI();
            saveGameDataToFirestore();

            // ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶®
            const feedback = document.createElement('div');
            feedback.textContent = '+1';
            feedback.classList.add('point-feedback');
            feedback.style.left = `${event.clientX}px`;
            feedback.style.top = `${event.clientY}px`;
            feedback.style.position = 'fixed'; 
            document.body.appendChild(feedback);

            feedback.addEventListener('animationend', () => {
                feedback.remove();
            });
        }
        
        // === ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ‡¶ì ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ===
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

                if (!firebaseConfig) throw new Error("Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                showStatus("üîê ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏‡ßá ‡¶∏‡¶æ‡¶á‡¶® ‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        clickArea.addEventListener('click', handleClick);
                        rewardAdBtn.addEventListener('click', handleAdReward); 
                        
                        // ‡¶Ü‡¶™‡¶ó‡ßç‡¶∞‡ßá‡¶° ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                        upgradesList.addEventListener('click', (event) => {
                            const button = event.target.closest('.upgrade-btn');
                            if (button && !button.disabled) {
                                buyUpgrade(button.dataset.upgradeId);
                            }
                        });

                        showStatus(`üëã ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, false);
                        
                        setupRealtimeListener(appId, userId);

                    } else {
                        userIdDisplay.textContent = '‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•';
                        showStatus("üî¥ ‡¶∏‡¶æ‡¶á‡¶® ‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶ó‡ßá‡¶Æ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§", true);
                    }
                });

            } catch (error) {
                console.error("Firebase ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:", error);
                showStatus(`‚ùå Firebase ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${error.message}`, true);
            }
        }
        
        // === ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶ì ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ===
        function setupRealtimeListener(appId, userId) {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/game_data/player_stats`);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentBalance = data.balance || 0;
                    profitPerHour = data.profitPerHour || 0;
                    lastCollectTime = data.lastCollectTime ? data.lastCollectTime.toDate().getTime() : Date.now();
                    
                    if (data.upgrades) {
                        data.upgrades.forEach(savedUpgrade => {
                            const gameUpgrade = gameUpgrades.find(u => u.id === savedUpgrade.id);
                            if (gameUpgrade) {
                                gameUpgrade.level = savedUpgrade.level;
                            }
                        });
                    }

                } else {
                    currentBalance = 0;
                    profitPerHour = 0;
                    gameUpgrades.forEach(u => u.level = 0);
                    lastCollectTime = Date.now();
                    saveGameDataToFirestore(); 
                }
                if (!autoCollectInterval) {
                     autoCollectInterval = setInterval(collectIdleProfit, 1000);
                }
                updateUI();
            }, (error) => {
                console.error("Firestore Realtime Error:", error);
                showStatus("üî¥ Firestore ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", true);
            });
        }
        
        function initializeTelegramWebApp() {
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                WebApp = Telegram.WebApp;
                WebApp.ready();
                
                const bgColor = WebApp.themeParams.bg_color || '#f7f9fb';
                const cardColor = WebApp.themeParams.secondary_bg_color || '#ffffff';
                document.body.style.backgroundColor = bgColor;
                document.querySelector('.card').style.backgroundColor = cardColor;
                
                WebApp.MainButton.setText("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: 0");
                WebApp.MainButton.textColor = WebApp.themeParams.button_text_color || '#ffffff';
                WebApp.MainButton.color = WebApp.themeParams.button_color || '#007bff';
                WebApp.MainButton.show();
                
                closeAppBtn.addEventListener('click', () => WebApp.close());

                showStatus("‚úÖ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ SDK ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ Firebase ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶õ‡¶ø...");

            } else {
                showStatus("‚ùå ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ SDK ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶ö‡¶≤‡¶õ‡ßá‡•§", true);
                closeAppBtn.disabled = true;
            }
        }

        // ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ
        window.onload = function() {
            initializeTelegramWebApp();
            initializeFirebase();
        };

        // ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
        window.addEventListener('beforeunload', () => {
             saveGameDataToFirestore();
             if (autoCollectInterval) clearInterval(autoCollectInterval);
        });

    </script>
</body>
</html>

